LambdaFunctionRole:
  Type: AWS::IAM::Role
  Properties:
    RoleName: ${self:service}-${self:provider.stage}-LambdaFunctionRole
    AssumeRolePolicyDocument:
      Version: "2012-10-17"
      Statement:
        - Effect: Allow
          Principal:
            Service:
              - lambda.amazonaws.com
          Action:
            - sts:AssumeRole
    Path: /
    ManagedPolicyArns:
      - !Ref LambdaFunctionPolicy


LambdaFunctionPolicy:
  Type: AWS::IAM::ManagedPolicy
  Properties:
    ManagedPolicyName: ${self:service}-${self:provider.stage}-LambdaFunctionPolicy
    PolicyDocument:
      Version: "2012-10-17"
      Statement:
        - Sid: AllowCloudwatchLogs
          Effect: Allow
          Action:
            - logs:CreateLogStream
            - logs:CreateLogGroup
            - logs:PutLogEvents
          Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*:*"
        - Sid: AllowAssignVPC
          Effect: Allow
          Action:
            - ec2:CreateNetworkInterface
            - ec2:DescribeNetworkInterfaces
            - ec2:DeleteNetworkInterface
            - ec2:AssignPrivateIpAddresses
            - ec2:UnassignPrivateIpAddresses
          Resource: "*"
        - Sid: AllowAccessS3
          Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:ListBucket
            - s3:PutBucketNotification
            - s3:DeleteObject
          Resource:
            - !Sub "arn:aws:s3:::*"
        - Sid: AllowReadWriteSSM
          Effect: Allow
          Action:
            - ssm:Put*
            - ssm:Get*
            - ssm:Describe*
          Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*"
        - Sid: AllowAccessDynamoDB
          Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Get*
            - dynamodb:List*
            - dynamodb:BatchGet*
            - dynamodb:BatchWrite*
            - dynamodb:Describe*
            - dynamodb:PutItem
            - dynamodb:DeleteItem
            - dynamodb:UpdateItem
          Resource:
            - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/*"
        - Sid: AllowSendMessagesToSQS
          Effect: Allow
          Action:
            - sqs:Get*
            - sqs:SendMessage
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:ChangeMessageVisibility
          Resource: !Sub "arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:*"
