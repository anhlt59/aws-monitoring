service: monitoring

stages:
  default:
    resolvers:
      aws-resolver:
        type: aws
        profile: ${self:custom.configs.Profile}

provider:
  name: aws
  resolver: aws-resolver
  stage: ${opt:stage, "dev"}
  region: ${opt:region, self:custom.configs.Region}
  stackName: monitoring-${self:provider.stage}

  # default tags for all resources
  stackTags:
    owner: monitoring
    environment: ${self:provider.stage}
  tags: ${self:provider.stackTags}

  # deployment
  deploymentBucket:
    name: ${self:custom.configs.S3.DeploymentBucket.Name}
  iam:
    deploymentRole: ${self:custom.configs.IAM.DeploymentRole}

  # config lambda functions
  runtime: python3.13
  logRetentionInDays: ${self:custom.configs.Lambda.LogRetentionInDays}
  memorySize: 256
  timeout: 10
  role: LambdaFunctionRole
  layers:
    - !Ref PythonRequirementsLambdaLayer

  environment:
    SERVICE: ${self:service}
    STAGE: ${self:provider.stage}
    POWERTOOLS_LOG_LEVEL: ${self:custom.configs.Lambda.Environment.LOG_LEVEL, "INFO"}
    # references to resources in this template
    AWS_DYNAMODB_TABLE: ${self:custom.configs.DynamoDB.TableName, "monitoring-local"}

plugins:
  - serverless-plugin-utils

useDotenv: true

custom:
  version: v1.0.1
  # load the configuration corresponding to a specific $stage
  configs: ${file(infra/configs/${self:provider.stage}.yml)}
  # plugins
  pythonRequirements: ${file(infra/plugins/python_requirements.yml):pythonRequirements}

package:
  individually: true
  excludeDevDependencies: true
  patterns:
    - "!./**"
    - src/adapters/**/?*.py
    - src/common/**/?*.py
    - src/domain/**/?*.py
    - src/entrypoints/**/?*.py
    - statics/*/?*

# Functions (merged)
functions:
  # functions
  HandleMonitoringEvents: ${file(infra/functions/HandleMonitoringEvents.yml):function}
  DailyReport: ${file(infra/functions/DailyReport.yml):function}

  # monitoring functions
  QueryErrorLogs: ${file(infra/functions/QueryErrorLogs.yml):function}

  # API -------------------------------------------------------------------------
  # Auth
  AuthLogin: ${file(infra/functions/api/Auth-Login.yml):function}
  AuthRefresh: ${file(infra/functions/api/Auth-Refresh.yml):function}
  AuthLogout: ${file(infra/functions/api/Auth-Logout.yml):function}
  AuthMe: ${file(infra/functions/api/Auth-Me.yml):function}

  # Events
  GetEvent: ${file(infra/functions/api/Event-GetItem.yml):function}
  ListEvents: ${file(infra/functions/api/Event-ListItems.yml):function}

  # Tasks
  ListTasks: ${file(infra/functions/api/Tasks-List.yml):function}
  GetTask: ${file(infra/functions/api/Tasks-Get.yml):function}
  CreateTask: ${file(infra/functions/api/Tasks-Create.yml):function}
  UpdateTask: ${file(infra/functions/api/Tasks-Update.yml):function}
  UpdateTaskStatus: ${file(infra/functions/api/Tasks-UpdateStatus.yml):function}
  DeleteTask: ${file(infra/functions/api/Tasks-Delete.yml):function}
  AddTaskComment: ${file(infra/functions/api/Tasks-AddComment.yml):function}

  # Users
  ListUsers: ${file(infra/functions/api/Users-List.yml):function}
  GetUser: ${file(infra/functions/api/Users-Get.yml):function}
  CreateUser: ${file(infra/functions/api/Users-Create.yml):function}
  UpdateUser: ${file(infra/functions/api/Users-Update.yml):function}
  ChangePassword: ${file(infra/functions/api/Users-ChangePassword.yml):function}
  DeleteUser: ${file(infra/functions/api/Users-Delete.yml):function}

  # Dashboard
  DashboardOverview: ${file(infra/functions/api/Dashboard-Overview.yml):function}
  DashboardEventsStats: ${file(infra/functions/api/Dashboard-EventsStats.yml):function}
  DashboardTasksStats: ${file(infra/functions/api/Dashboard-TasksStats.yml):function}
  DashboardUsersStats: ${file(infra/functions/api/Dashboard-UsersStats.yml):function}

  # Configuration
  ConfigGetAws: ${file(infra/functions/api/Config-GetAws.yml):function}
  ConfigUpdateAws: ${file(infra/functions/api/Config-UpdateAws.yml):function}
  ConfigTestAws: ${file(infra/functions/api/Config-TestAws.yml):function}
  ConfigGetMonitoring: ${file(infra/functions/api/Config-GetMonitoring.yml):function}
  ConfigUpdateMonitoring: ${file(infra/functions/api/Config-UpdateMonitoring.yml):function}

resources:
  # -----------------------------------------------------------------------------
  Parameters:
    Stage:
      Type: String
      Default: ${self:provider.stage}
      AllowedValues: [ local, dev, prod ]
  # -----------------------------------------------------------------------------
  Resources:
    # IAM
    LambdaFunctionRole: ${file(infra/resources/iam.yml):LambdaFunctionRole}
    LambdaFunctionPolicy: ${file(infra/resources/iam.yml):LambdaFunctionPolicy}
    EventBridgeRole: ${file(infra/resources/iam.yml):EventBridgeRole}
    EventBridgePolicy: ${file(infra/resources/iam.yml):EventBridgePolicy}
    # EventBridge
    MonitoringEventRule: ${file(infra/resources/event_bridge.yml):MonitoringEventRule}
    DeploymentEventRule: ${file(infra/resources/event_bridge.yml):DeploymentEventRule}
    # SQS
    MonitoringEventRuleDLQ: ${file(infra/resources/sqs.yml):MonitoringEventRuleDLQ}
    # DynamoDB
    DynamoDBTable: ${file(infra/resources/dynamodb.yml):DynamoDBTable}
  # -----------------------------------------------------------------------------
  Outputs: { }
